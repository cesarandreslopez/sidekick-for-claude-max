---
phase: 01-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - sidekick-vscode/package.json
  - sidekick-vscode/src/extension.ts
autonomous: true

must_haves:
  truths:
    - "User can set API key via command palette"
    - "User can test connection via command palette"
    - "User can switch auth mode in settings and extension responds"
    - "Extension activates without Python server dependency"
    - "Extension host remains responsive during API operations"
  artifacts:
    - path: "sidekick-vscode/package.json"
      provides: "Auth mode settings and commands"
      contains: "sidekick.authMode"
    - path: "sidekick-vscode/src/extension.ts"
      provides: "AuthService integration"
      contains: "AuthService"
  key_links:
    - from: "extension.ts"
      to: "AuthService"
      via: "import and instantiation in activate()"
      pattern: "new AuthService"
    - from: "package.json commands"
      to: "extension.ts registerCommand"
      via: "command ID matching"
      pattern: "sidekick.setApiKey"
---

<objective>
Integrate AuthService into extension and add auth configuration settings.

Purpose: Wire the authentication layer into the extension lifecycle, add VS Code settings for auth mode selection, and register commands for setting API key and testing connection. After this plan, users can configure and test both authentication modes.
Output: Updated package.json with auth settings/commands, updated extension.ts with AuthService integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

@sidekick-vscode/package.json
@sidekick-vscode/src/extension.ts
@sidekick-vscode/src/services/AuthService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add auth settings and commands to package.json</name>
  <files>sidekick-vscode/package.json</files>
  <action>
Update package.json contributes section to add auth configuration and commands.

Add to configuration.properties (BEFORE sidekick.serverUrl):
```json
"sidekick.authMode": {
  "type": "string",
  "enum": ["api-key", "max-subscription"],
  "default": "max-subscription",
  "description": "Authentication mode for Claude API",
  "enumDescriptions": [
    "Use an Anthropic API key (requires ANTHROPIC_API_KEY env var or configured key)",
    "Use Claude Max subscription (requires Claude Code CLI installed and authenticated)"
  ]
},
```

Add to commands array:
```json
{
  "command": "sidekick.setApiKey",
  "title": "Sidekick: Set API Key"
},
{
  "command": "sidekick.testConnection",
  "title": "Sidekick: Test Connection"
}
```

Keep the existing sidekick.serverUrl setting for now (will be removed in Phase 4 cleanup). The serverUrl won't be used once we integrate AuthService, but removing it now would break existing users during migration.

The sidekick.apiKey setting from research is NOT needed in package.json - we use SecretStorage directly, not a settings entry (settings would expose the key in settings UI/JSON).
  </action>
  <verify>
Check settings: `grep -A3 "sidekick.authMode" sidekick-vscode/package.json`
Check commands: `grep "sidekick.setApiKey\|sidekick.testConnection" sidekick-vscode/package.json`
Valid JSON: `cd sidekick-vscode && node -e "require('./package.json')"`
  </verify>
  <done>package.json has authMode setting with enum and both new commands registered.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate AuthService into extension lifecycle</name>
  <files>sidekick-vscode/src/extension.ts</files>
  <action>
Update extension.ts to use AuthService instead of HTTP server calls.

1. Add imports at top:
```typescript
import { AuthService } from './services/AuthService';
```

2. Add module-level variable (near other module vars like statusBarItem):
```typescript
let authService: AuthService | undefined;
```

3. In activate() function, after creating status bar but BEFORE registering the inline provider:
```typescript
// Initialize auth service
authService = new AuthService(context);
context.subscriptions.push(authService);
```

4. Register the setApiKey command (add to existing command registrations):
```typescript
context.subscriptions.push(
  vscode.commands.registerCommand('sidekick.setApiKey', async () => {
    const key = await vscode.window.showInputBox({
      prompt: 'Enter your Anthropic API Key',
      placeHolder: 'sk-ant-...',
      password: true,
      ignoreFocusOut: true,
    });

    if (key) {
      await authService?.getSecretsManager().setApiKey(key);
      vscode.window.showInformationMessage('API key saved securely.');
    }
  })
);
```

5. Register the testConnection command:
```typescript
context.subscriptions.push(
  vscode.commands.registerCommand('sidekick.testConnection', async () => {
    if (!authService) {
      vscode.window.showErrorMessage('Auth service not initialized');
      return;
    }

    const result = await vscode.window.withProgress(
      {
        location: vscode.ProgressLocation.Notification,
        title: 'Testing connection...',
        cancellable: false,
      },
      async () => authService!.testConnection()
    );

    if (result.success) {
      vscode.window.showInformationMessage(result.message);
    } else {
      vscode.window.showErrorMessage(result.message);
    }
  })
);
```

6. Update deactivate() to clean up authService:
```typescript
export function deactivate(): void {
  if (debounceTimer) {
    clearTimeout(debounceTimer);
  }
  // AuthService cleanup happens via context.subscriptions
}
```

Note: The inline completion provider still uses HTTP for now - that integration will happen in Phase 2 (Completions). This plan focuses on establishing the auth infrastructure and making it configurable/testable.
  </action>
  <verify>
TypeScript compiles: `cd sidekick-vscode && npx tsc --noEmit`
AuthService imported: `grep "import.*AuthService" sidekick-vscode/src/extension.ts`
Commands registered: `grep "sidekick.setApiKey\|sidekick.testConnection" sidekick-vscode/src/extension.ts`
  </verify>
  <done>AuthService initialized in activate(), both commands registered, cleanup in subscriptions.</done>
</task>

<task type="auto">
  <name>Task 3: Verify end-to-end functionality</name>
  <files>none (verification only)</files>
  <action>
Build and manually verify the extension works:

1. Build the extension:
```bash
cd sidekick-vscode && npm run compile
```

2. Verify the build succeeded and output exists:
```bash
ls -la out/extension.js
```

3. Check that the extension can be loaded (no runtime import errors):
   - The extension should activate without errors
   - Run a quick syntax check on the bundled output

4. Create a simple smoke test by checking the bundle includes our new code:
```bash
grep -l "AuthService\|setApiKey\|testConnection" out/extension.js
```

Note: Full integration testing (actually running in VS Code) will be done via checkpoint:human-verify in a later phase. This task confirms the code compiles and bundles correctly.
  </action>
  <verify>
Build succeeds: `cd sidekick-vscode && npm run compile && echo "Build OK"`
Bundle contains AuthService: `grep "AuthService" sidekick-vscode/out/extension.js > /dev/null && echo "AuthService found in bundle"`
No TypeScript errors: `cd sidekick-vscode && npx tsc --noEmit && echo "Types OK"`
  </verify>
  <done>Extension compiles, bundles, and includes all new auth functionality.</done>
</task>

</tasks>

<verification>
After all tasks:
1. `cd sidekick-vscode && npm run compile` - succeeds
2. `npx tsc --noEmit` - no type errors
3. package.json has authMode setting with api-key and max-subscription options
4. package.json has sidekick.setApiKey and sidekick.testConnection commands
5. extension.ts imports and instantiates AuthService
6. Bundle includes AuthService code
</verification>

<success_criteria>
- sidekick.authMode setting available with two options (api-key, max-subscription)
- sidekick.setApiKey command registered and prompts for key
- sidekick.testConnection command registered and tests current auth mode
- AuthService instantiated during activate() and added to subscriptions
- Extension compiles and bundles without errors
- No Python server dependency in the new code paths
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
