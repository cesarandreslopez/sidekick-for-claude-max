---
phase: 03-transforms-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sidekick-vscode/src/services/StatusBarManager.ts
  - sidekick-vscode/src/utils/prompts.ts
  - sidekick-vscode/src/extension.ts
autonomous: true

must_haves:
  truths:
    - "Status bar shows connected state with sparkle icon when enabled"
    - "Status bar shows disconnected state with circle-slash icon when disabled"
    - "Status bar shows loading spinner during API operations"
    - "Status bar shows error state with error icon and red background on failure"
    - "Status bar tooltip shows current model name"
  artifacts:
    - path: "sidekick-vscode/src/services/StatusBarManager.ts"
      provides: "Centralized status bar state management"
      exports: ["StatusBarManager", "ConnectionState"]
      min_lines: 80
    - path: "sidekick-vscode/src/utils/prompts.ts"
      provides: "Transform prompt templates"
      exports: ["getTransformSystemPrompt", "getTransformUserPrompt", "cleanTransformResponse"]
  key_links:
    - from: "sidekick-vscode/src/extension.ts"
      to: "StatusBarManager"
      via: "import and instantiation"
      pattern: "new StatusBarManager"
    - from: "sidekick-vscode/src/extension.ts"
      to: "context.subscriptions"
      via: "push statusBarManager"
      pattern: "context\\.subscriptions\\.push.*statusBarManager"
---

<objective>
Create StatusBarManager for centralized status bar state management and add transform prompt templates.

Purpose: Provides the foundation for enhanced UX (multi-state status bar) and transform functionality (prompt generation). StatusBarManager replaces the simple toggle pattern with proper connection state tracking.

Output:
- StatusBarManager class with connected/disconnected/loading/error states
- Transform prompt templates (system prompt, user prompt, response cleaning)
- Extension.ts updated to use StatusBarManager instead of raw StatusBarItem
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-transforms-ux/03-RESEARCH.md

# Source files to modify
@sidekick-vscode/src/extension.ts
@sidekick-vscode/src/utils/prompts.ts
@sidekick-vscode/src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StatusBarManager service</name>
  <files>sidekick-vscode/src/services/StatusBarManager.ts</files>
  <action>
Create StatusBarManager class implementing vscode.Disposable with:

**Type:** Export ConnectionState type: 'connected' | 'disconnected' | 'loading' | 'error'

**State properties:**
- state: ConnectionState (default 'disconnected')
- currentModel: string (default 'haiku')
- errorMessage: string | undefined
- private statusBarItem: vscode.StatusBarItem

**Constructor:**
- Create StatusBarItem with Right alignment, priority 100
- Set command to 'sidekick.toggle'
- Call update() and show()

**Methods:**
- setConnected(): Set state='connected', clear errorMessage, call update()
- setDisconnected(): Set state='disconnected', clear errorMessage, call update()
- setLoading(operation?: string): Set state='loading', clear errorMessage, call update(operation)
- setError(message: string): Set state='error', set errorMessage, call update()
- setModel(model: string): Set currentModel, call update()
- getState(): ConnectionState - Return current state
- private update(operation?: string): Update statusBarItem based on state

**Icons per state (use Codicons):**
- connected: `$(sparkle) Sidekick`
- disconnected: `$(circle-slash) Sidekick`
- loading: `$(sync~spin) Sidekick`
- error: `$(error) Sidekick`

**Tooltips per state:**
- connected: `Sidekick: Connected (${currentModel})`
- disconnected: `Sidekick: Disabled (click to enable)`
- loading: `Sidekick: ${operation || 'Working'}...`
- error: `Sidekick Error: ${errorMessage}`

**Background per state:**
- error: new vscode.ThemeColor('statusBarItem.errorBackground')
- all others: undefined (clear background)

**dispose():** Call statusBarItem.dispose()

Add JSDoc comments following existing service patterns.
  </action>
  <verify>
    - File exists at sidekick-vscode/src/services/StatusBarManager.ts
    - `npm run compile` succeeds without errors
    - StatusBarManager and ConnectionState are exported
  </verify>
  <done>StatusBarManager class created with all four states and proper Disposable pattern</done>
</task>

<task type="auto">
  <name>Task 2: Add transform prompt templates to prompts.ts</name>
  <files>sidekick-vscode/src/utils/prompts.ts</files>
  <action>
Add three new functions to the existing prompts.ts file:

**getTransformSystemPrompt():** Returns system prompt for transforms:
```
You are a code transformation assistant. Transform the provided code according to the user's instruction.

RULES:
- Output ONLY the transformed code
- Preserve the code's functionality unless the instruction changes it
- Maintain the same programming language
- Keep the same indentation style
- NO explanations before or after the code
- NO markdown code blocks
- If the instruction is unclear, make a reasonable interpretation
```

**getTransformUserPrompt(code: string, instruction: string, language: string, prefix?: string, suffix?: string):**
Returns user prompt with format:
```
Language: ${language}

[If prefix provided:]
Context before:
${prefix}

Code to transform:
${code}

[If suffix provided:]
Context after:
${suffix}

Instruction: ${instruction}

Transformed code:
```

**cleanTransformResponse(text: string):** Similar to cleanCompletion but for transforms:
- Remove markdown code blocks (```language ... ```)
- Check for conversational prefixes (starts with "Here", "The transformed", "I've", "I have")
- If conversational prefix found, try to extract code after first newline
- Return cleaned code or undefined if invalid

Add JSDoc comments for all three functions.
  </action>
  <verify>
    - `npm run compile` succeeds
    - All three functions are exported from prompts.ts
    - TypeScript types are correct
  </verify>
  <done>Transform prompt templates added: getTransformSystemPrompt, getTransformUserPrompt, cleanTransformResponse</done>
</task>

<task type="auto">
  <name>Task 3: Wire StatusBarManager into extension.ts</name>
  <files>sidekick-vscode/src/extension.ts</files>
  <action>
Update extension.ts to use StatusBarManager instead of raw StatusBarItem:

**Replace module-level variables:**
- Remove: `let statusBarItem: vscode.StatusBarItem;`
- Keep: `let enabled = true;`
- Add: `let statusBarManager: StatusBarManager | undefined;`

**Update imports:**
- Add: `import { StatusBarManager } from './services/StatusBarManager';`

**In activate():**
- Remove: StatusBarItem creation code (lines 64-72)
- Remove: updateStatusBar() call
- Add: `statusBarManager = new StatusBarManager();`
- Add: `context.subscriptions.push(statusBarManager);`

**Update toggle command:**
- Replace `updateStatusBar()` with:
  - If enabled: `statusBarManager.setConnected()`
  - If disabled: `statusBarManager.setDisconnected()`

**Update testConnection command:**
- Before testConnection call: `statusBarManager?.setLoading('Testing connection')`
- On success: `statusBarManager?.setConnected()`
- On failure: `statusBarManager?.setError(result.message)`

**Remove:**
- The updateStatusBar() function (no longer needed)

Keep the transform command unchanged for now (Plan 02 migrates it).
  </action>
  <verify>
    - `npm run compile` succeeds
    - No TypeScript errors
    - Extension activates without errors (test in VS Code)
    - Status bar shows sparkle icon and clicking toggles state
  </verify>
  <done>Extension uses StatusBarManager; toggle and testConnection update status bar states</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run compile` succeeds with no errors
2. `npm run lint` passes (or only has pre-existing warnings)
3. Extension activates and shows status bar item
4. Clicking status bar toggles between connected/disconnected visuals
5. Test Connection command shows loading spinner, then connected or error state
</verification>

<success_criteria>
- StatusBarManager class exists with all four connection states
- Transform prompt templates exist in prompts.ts
- Extension uses StatusBarManager instead of raw StatusBarItem
- Status bar shows correct icons and tooltips for each state
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-transforms-ux/03-01-SUMMARY.md`
</output>
