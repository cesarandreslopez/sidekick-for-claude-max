---
phase: 03-transforms-ux
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - sidekick-vscode/src/extension.ts
autonomous: true

must_haves:
  truths:
    - "User can select code and invoke sidekick.transform command"
    - "User is prompted for transformation instruction via input box"
    - "Selected code is replaced with Claude-transformed result"
    - "Status bar shows loading spinner during transform"
    - "Status bar shows error state if transform fails"
    - "Transform uses AuthService SDK, not HTTP server"
  artifacts:
    - path: "sidekick-vscode/src/extension.ts"
      provides: "Transform command using AuthService"
      contains: "authService.complete"
  key_links:
    - from: "sidekick.transform command"
      to: "AuthService.complete"
      via: "direct call with transform prompt"
      pattern: "authService\\.complete.*Transform"
    - from: "sidekick.transform command"
      to: "StatusBarManager"
      via: "setLoading/setConnected/setError calls"
      pattern: "statusBarManager\\?.set(Loading|Connected|Error)"
    - from: "sidekick.transform command"
      to: "getTransformSystemPrompt"
      via: "import from prompts"
      pattern: "getTransformSystemPrompt"
---

<objective>
Migrate transform command from HTTP server to AuthService SDK and wire status bar updates.

Purpose: Completes Phase 3 by migrating the last HTTP-dependent feature to the SDK, removes server dependency for transforms, and integrates transform operations with the new StatusBarManager for proper loading/error feedback.

Output:
- Transform command uses AuthService.complete() instead of fetchTransform()
- Status bar shows loading state during transforms
- HTTP fetchTransform function removed
- No more HTTP/HTTPS imports needed
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-transforms-ux/03-RESEARCH.md
@.planning/phases/03-transforms-ux/03-01-SUMMARY.md

# Source files
@sidekick-vscode/src/extension.ts
@sidekick-vscode/src/utils/prompts.ts
@sidekick-vscode/src/services/StatusBarManager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate transform command to AuthService</name>
  <files>sidekick-vscode/src/extension.ts</files>
  <action>
Rewrite the sidekick.transform command to use AuthService instead of HTTP:

**Add imports:**
```typescript
import {
  getTransformSystemPrompt,
  getTransformUserPrompt,
  cleanTransformResponse,
} from './utils/prompts';
```

**Rewrite sidekick.transform command registration:**

1. Keep the editor and selection validation at the start

2. Keep the input box for instruction (add `ignoreFocusOut: true`)

3. Keep context gathering (prefix, suffix with contextLines)

4. Read model from config: `config.get<string>('transformModel') ?? 'opus'`

5. Replace the withProgress block with StatusBarManager-based flow:

```typescript
// Capture selection state before async operation
const originalSelection = editor.selection;
const selectedText = editor.document.getText(originalSelection);

statusBarManager?.setLoading('Transforming');

try {
  // Build prompt using prompt templates
  const prompt = getTransformSystemPrompt() + '\n\n' +
    getTransformUserPrompt(selectedText, instruction, language, prefix, suffix);

  // Use AuthService instead of HTTP
  const result = await authService!.complete(prompt, {
    model,
    maxTokens: 4096,
    timeout: 60000, // Transforms can take longer
  });

  // Clean the response
  const cleaned = cleanTransformResponse(result);
  if (!cleaned) {
    vscode.window.showWarningMessage('No transformation returned');
    statusBarManager?.setConnected();
    return;
  }

  // Verify selection hasn't changed
  if (!editor.selection.isEqual(originalSelection)) {
    vscode.window.showWarningMessage('Selection changed during transform. Please try again.');
    statusBarManager?.setConnected();
    return;
  }

  // Apply the edit
  const success = await editor.edit((editBuilder) => {
    editBuilder.replace(originalSelection, cleaned);
  });

  if (success) {
    statusBarManager?.setConnected();
  } else {
    statusBarManager?.setError('Edit failed');
    vscode.window.showErrorMessage('Failed to apply transformation');
  }
} catch (error) {
  const message = error instanceof Error ? error.message : 'Unknown error';
  statusBarManager?.setError(message);
  vscode.window.showErrorMessage(`Transform failed: ${message}`);
}
```

6. Remove `serverUrl` config reading (no longer needed)

**Important:** Keep the filename extraction for potential future use, but it's not used in current prompt templates.
  </action>
  <verify>
    - `npm run compile` succeeds
    - No TypeScript errors about authService or statusBarManager
    - Transform command no longer references fetchTransform or serverUrl
  </verify>
  <done>Transform command uses AuthService.complete() with StatusBarManager integration</done>
</task>

<task type="auto">
  <name>Task 2: Remove HTTP code and unused imports</name>
  <files>sidekick-vscode/src/extension.ts</files>
  <action>
Clean up HTTP-related code that's no longer needed:

**Remove imports:**
```typescript
import * as https from "https";
import * as http from "http";
```

**Remove interface:**
```typescript
interface TransformResponse {
  modified_code: string;
  error?: string;
  requestId?: string;
  statusCode?: number;
}
```

**Remove function:**
Delete the entire `fetchTransform()` function (approximately lines 269-321).

**Verify no HTTP references remain:**
Search for `http.request`, `https.request`, `fetchTransform` - none should exist.
  </action>
  <verify>
    - `npm run compile` succeeds
    - No imports for http or https modules
    - No TransformResponse interface
    - No fetchTransform function
    - Search for "http" in extension.ts returns no results
  </verify>
  <done>HTTP code removed; extension has no server dependency for transforms</done>
</task>

<task type="auto">
  <name>Task 3: Update model display on status bar</name>
  <files>sidekick-vscode/src/extension.ts</files>
  <action>
Ensure the status bar shows the current model in use:

**In activate(), after creating authService:**
```typescript
// Initialize status bar with configured model
const config = vscode.workspace.getConfiguration('sidekick');
const inlineModel = config.get<string>('inlineModel') ?? 'haiku';
statusBarManager?.setModel(inlineModel);
```

**Add configuration change listener for model updates:**
```typescript
context.subscriptions.push(
  vscode.workspace.onDidChangeConfiguration(e => {
    if (e.affectsConfiguration('sidekick.inlineModel')) {
      const config = vscode.workspace.getConfiguration('sidekick');
      const model = config.get<string>('inlineModel') ?? 'haiku';
      statusBarManager?.setModel(model);
    }
  })
);
```

This ensures:
- Status bar shows correct model on startup
- Status bar updates when user changes inlineModel setting
- Tooltip says "Sidekick: Connected (haiku)" or whichever model
  </action>
  <verify>
    - `npm run compile` succeeds
    - Status bar tooltip shows model name when connected
    - Changing sidekick.inlineModel setting updates tooltip
  </verify>
  <done>Status bar displays current model; updates on configuration change</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run compile` succeeds with no errors
2. `npm run lint` passes
3. Extension activates and works:
   - Select code, run "Sidekick: Transform Selected Code"
   - Status bar shows spinning icon during transform
   - Code is replaced with transformed result
   - Status bar returns to connected state
4. No HTTP code remains in extension.ts
5. Status bar tooltip shows current model
</verification>

<success_criteria>
- Transform command works using AuthService (no HTTP)
- Status bar shows loading during transforms
- Status bar shows error on failure
- HTTP imports and fetchTransform function removed
- Status bar tooltip shows current model name
- Extension works end-to-end (completions + transforms)
</success_criteria>

<output>
After completion, create `.planning/phases/03-transforms-ux/03-02-SUMMARY.md`
</output>
